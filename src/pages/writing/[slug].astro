---
import { getPublishedBlogPosts, type BlogPost } from "../../lib/content/blog";
import BaseLayout from "../../layouts/BaseLayout.astro";
import SubscribeInline from "../../components/SubscribeInline.astro";

export async function getStaticPaths() {
  const posts = await getPublishedBlogPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props as { post: BlogPost };
const { Content } = await post.render();
const title = `${post.data.title} | Jose Flores`;
const description = post.data.description;
const subscribeVariant = post.data.series
  ? post.data.isSeriesFinal
    ? "seriesComplete"
    : "seriesActive"
  : "generic";
const canonicalUrl = Astro.site
  ? new URL(`/writing/${post.slug}/`, Astro.site).toString()
  : new URL(`/writing/${post.slug}/`, Astro.url).toString();
const blogSchema: Record<string, unknown> = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.data.title,
  description: post.data.description,
  datePublished: post.data.pubDate.toISOString(),
  author: {
    "@type": "Person",
    name: "Jose Flores",
    url: "https://0xjcf.com",
  },
  mainEntityOfPage: canonicalUrl,
};

if (post.data.updatedDate) {
  blogSchema.dateModified = post.data.updatedDate.toISOString();
}
---

<BaseLayout
  title={title}
  description={description}
  bodyClass="no-js"
  canonical={canonicalUrl}
  ogType="article"
>
  <Fragment slot="head">
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify(blogSchema)}
    />
    <script defer type="module" src="/scripts/pe.js"></script>
    <script defer type="module" src="/scripts/mermaid-diagrams.js"></script>
  </Fragment>
  <main
    id="main"
    role="main"
    class="section section--writing-page page-content"
  >
    <div class="container">
      <article class="writing-article">
        <header>
          <h1 class="section__title">{post.data.title}</h1>
          <p class="lead writing-article__summary">{post.data.description}</p>
        </header>
        <div class="section__content writing-article__content">
          <Content />
        </div>
        <SubscribeInline
          seriesName={post.data.series}
          variant={subscribeVariant}
          formId={`subscribe-${post.slug}`}
        />
      </article>
    </div>
  </main>
  <script is:inline>
    (() => {
      const applyLabelStyles = () => {
        const root = document.querySelector(".writing-article");
        if (!root) return;
        const styles = getComputedStyle(document.documentElement);
        const surface =
          styles.getPropertyValue("--color-surface-alt") || "#f5f7fa";
        const text = styles.getPropertyValue("--color-text") || "#111";
        root.querySelectorAll('svg[id^="mermaid-"] .labelBkg').forEach((el) => {
          el.style.backgroundColor = surface;
          el.style.color = text;
          el.style.padding = "2px 6px";
          el.style.borderRadius = "4px";
          el.style.opacity = "1";
        });
      };

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", applyLabelStyles, {
          once: true,
        });
      } else {
        applyLabelStyles();
      }
    })();
  </script>
</BaseLayout>
