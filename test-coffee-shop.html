<!DOCTYPE html>
<html>
<head>
    <title>Coffee Shop State Machine Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0f1115;
            color: #e0e0e0;
        }
        h1 { color: #0d99ff; }
        .test-section {
            background: #1a1c21;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .log {
            background: #000;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 4px;
        }
        .log-entry { margin: 2px 0; }
        .success { color: #90f090; }
        .error { color: #ff6060; }
        .info { color: #60b0ff; }
        button {
            background: #0d99ff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #0b7acc; }
        .state-display {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .actor-state {
            background: #2a2c31;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
        }
        .actor-state h3 { margin-top: 0; }
    </style>
</head>
<body>
    <h1>Coffee Shop State Machine Test</h1>
    
    <div class="test-section">
        <h2>State Machine Test Runner</h2>
        <div class="state-display" id="stateDisplay">
            <div class="actor-state">
                <h3>Customer</h3>
                <div id="customerState">idle</div>
            </div>
            <div class="actor-state">
                <h3>Cashier</h3>
                <div id="cashierState">idle</div>
            </div>
            <div class="actor-state">
                <h3>Barista</h3>
                <div id="baristaState">idle</div>
                <div id="baristaQueue">Queue: 0</div>
            </div>
        </div>
        
        <div>
            <button onclick="runTest('singleOrder')">Test Single Order</button>
            <button onclick="runTest('multipleOrders')">Test Multiple Orders</button>
            <button onclick="runTest('concurrentOrders')">Test Concurrent Orders</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <h3>Test Log:</h3>
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        import { createActor } from 'https://cdn.jsdelivr.net/npm/xstate@5/+esm';
        import { coffeeShopMachine } from './components/actors/coffee-shop-machine.js';
        
        let coffeeShopActor = null;
        let testTimeout = null;
        
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function updateStateDisplay(context) {
            document.getElementById('customerState').textContent = context.customerState || 'unknown';
            document.getElementById('cashierState').textContent = context.cashierState || 'unknown';
            document.getElementById('baristaState').textContent = context.baristaState || 'unknown';
            document.getElementById('baristaQueue').textContent = 
                `Queue: ${context.baristaContext?.orderQueue?.length || 0} | Completed: ${context.baristaContext?.completedOrders || 0}`;
        }
        
        window.runTest = async function(testType) {
            log(`Starting test: ${testType}`, 'info');
            
            // Stop existing actor if any
            if (coffeeShopActor) {
                coffeeShopActor.stop();
            }
            
            // Clear any existing timeout
            if (testTimeout) {
                clearTimeout(testTimeout);
            }
            
            // Create new actor
            coffeeShopActor = createActor(coffeeShopMachine);
            
            // Subscribe to state changes
            coffeeShopActor.subscribe((state) => {
                const { context } = state;
                updateStateDisplay(context);
                
                // Log state transitions
                if (context.prevCustomerState !== context.customerState) {
                    log(`Customer: ${context.prevCustomerState} → ${context.customerState}`, 'success');
                }
                if (context.prevCashierState !== context.cashierState) {
                    log(`Cashier: ${context.prevCashierState} → ${context.cashierState}`, 'success');
                }
                if (context.prevBaristaState !== context.baristaState) {
                    log(`Barista: ${context.prevBaristaState} → ${context.baristaState}`, 'success');
                }
            });
            
            coffeeShopActor.start();
            
            switch (testType) {
                case 'singleOrder':
                    log('Testing single order flow...', 'info');
                    coffeeShopActor.send({ type: 'CUSTOMER_ORDER' });
                    
                    // Verify states after various delays
                    setTimeout(() => {
                        const state = coffeeShopActor.getSnapshot();
                        if (state.context.customerState === 'ordering') {
                            log('✓ Customer is ordering', 'success');
                        } else {
                            log(`✗ Expected customer to be ordering, but was ${state.context.customerState}`, 'error');
                        }
                    }, 500);
                    
                    setTimeout(() => {
                        const state = coffeeShopActor.getSnapshot();
                        if (state.context.customerState === 'waiting') {
                            log('✓ Customer is waiting (order placed)', 'success');
                        } else {
                            log(`✗ Expected customer to be waiting, but was ${state.context.customerState}`, 'error');
                        }
                        
                        if (state.context.baristaState !== 'idle') {
                            log('✓ Barista started making coffee', 'success');
                        } else {
                            log('✗ Barista should be making coffee', 'error');
                        }
                    }, 3000);
                    
                    testTimeout = setTimeout(() => {
                        const state = coffeeShopActor.getSnapshot();
                        if (state.context.customerState === 'enjoying') {
                            log('✓ Customer received coffee and is enjoying it', 'success');
                            log('✓ Single order test PASSED', 'success');
                        } else {
                            log(`✗ Expected customer to be enjoying coffee, but was ${state.context.customerState}`, 'error');
                            log('✗ Single order test FAILED', 'error');
                        }
                    }, 10000);
                    break;
                    
                case 'multipleOrders':
                    log('Testing multiple sequential orders...', 'info');
                    
                    // Send orders with delays
                    coffeeShopActor.send({ type: 'CUSTOMER_ORDER' });
                    setTimeout(() => coffeeShopActor.send({ type: 'CUSTOMER_ORDER' }), 2000);
                    setTimeout(() => coffeeShopActor.send({ type: 'CUSTOMER_ORDER' }), 4000);
                    
                    testTimeout = setTimeout(() => {
                        const state = coffeeShopActor.getSnapshot();
                        const queueLength = state.context.baristaContext?.orderQueue?.length || 0;
                        const completed = state.context.baristaContext?.completedOrders || 0;
                        
                        log(`Orders in queue: ${queueLength}`, 'info');
                        log(`Orders completed: ${completed}`, 'info');
                        
                        if (completed >= 1) {
                            log('✓ Multiple orders are being processed', 'success');
                        } else {
                            log('✗ Orders not being processed correctly', 'error');
                        }
                    }, 15000);
                    break;
                    
                case 'concurrentOrders':
                    log('Testing concurrent orders (rush hour)...', 'info');
                    
                    // Send 3 orders immediately
                    for (let i = 0; i < 3; i++) {
                        coffeeShopActor.send({ type: 'CUSTOMER_ORDER' });
                        log(`Sent order ${i + 1}`, 'info');
                    }
                    
                    // Check queue after a moment
                    setTimeout(() => {
                        const state = coffeeShopActor.getSnapshot();
                        const queueLength = state.context.baristaContext?.orderQueue?.length || 0;
                        
                        if (queueLength > 0) {
                            log(`✓ Barista queue has ${queueLength} orders`, 'success');
                        } else {
                            log('✗ Barista queue should have orders', 'error');
                        }
                        
                        if (state.context.baristaState !== 'idle') {
                            log('✓ Barista is actively working', 'success');
                        }
                    }, 1000);
                    
                    testTimeout = setTimeout(() => {
                        const state = coffeeShopActor.getSnapshot();
                        const completed = state.context.baristaContext?.completedOrders || 0;
                        
                        log(`Total orders completed: ${completed}`, 'info');
                        
                        if (completed >= 2) {
                            log('✓ Concurrent orders test PASSED', 'success');
                        } else {
                            log('✗ Not enough orders completed', 'error');
                        }
                    }, 20000);
                    break;
            }
        };
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        };
        
        // Initial log
        log('Coffee Shop State Machine Test Runner ready', 'info');
        log('Click a test button to start testing', 'info');
    </script>
</body>
</html>