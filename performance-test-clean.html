<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Performance Test - Site Only</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, system-ui, sans-serif;
            background: #1a1a1a; 
            color: #fff; 
            padding: 20px;
        }
        h1 { 
            margin-bottom: 20px; 
            color: #ff6e3c; 
            font-size: 24px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            background: #ff6e3c;
            color: #fff;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #ff5a24; }
        select {
            background: #333;
            color: #fff;
            padding: 8px;
            border: 1px solid #ff6e3c;
            border-radius: 4px;
            font-size: 14px;
        }
        .results {
            background: rgba(0,0,0,0.5);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        .good { color: #10b981; }
        .warning { color: #f59e0b; }
        .bad { color: #ef4444; }
        .info { color: #3b82f6; }
        #frameWrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 500px;
            padding: 20px;
            position: relative;
        }
        iframe { 
            background: white;
            border: none;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        }
        /* Device bezels */
        .mobile-frame iframe {
            border-radius: 30px;
        }
        .mobile-frame {
            position: relative;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 40px;
            box-shadow: 
                0 0 0 1px rgba(255,255,255,0.1),
                0 10px 40px rgba(0,0,0,0.5),
                inset 0 0 0 2px rgba(255,255,255,0.05);
        }
        .mobile-frame::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: #000;
            border-radius: 2px;
            z-index: 1;
        }
        .tablet-frame iframe {
            border-radius: 20px;
        }
        .tablet-frame {
            position: relative;
            padding: 20px;
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            border-radius: 30px;
            box-shadow: 
                0 0 0 1px rgba(255,255,255,0.1),
                0 10px 40px rgba(0,0,0,0.5);
        }
        .tablet-frame::before {
            content: '';
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: #333;
            border-radius: 50%;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
        }
        .desktop-frame iframe {
            border-radius: 8px;
        }
        .desktop-frame {
            position: relative;
            padding: 10px;
            background: linear-gradient(145deg, #333, #222);
            border-radius: 12px;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.1);
        }
        .desktop-frame::after {
            content: '';
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 20px;
            background: linear-gradient(145deg, #444, #222);
            border-radius: 0 0 10px 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>üéØ Clean Performance Test - Measuring Site Only</h1>
    
    <div class="controls">
        <select id="viewMode">
            <!-- Mobile devices matching your breakpoints -->
            <option value="mobile-se">iPhone SE (375√ó667)</option>
            <option value="mobile" selected>iPhone 14 (390√ó844)</option>
            <option value="mobile-plus">iPhone 14 Plus (428√ó926)</option>
            <option value="android">Android (412√ó915)</option>
            <!-- Tablet at your 768px breakpoint -->
            <option value="tablet-portrait">iPad Portrait (768√ó1024)</option>
            <option value="tablet-landscape">iPad Landscape (1024√ó768)</option>
            <!-- Desktop sizes -->
            <option value="laptop">Laptop (1366√ó768)</option>
            <option value="desktop">Desktop FHD (1920√ó1080)</option>
            <option value="desktop-wide">Desktop Wide (2560√ó1440)</option>
            <!-- Edge cases for your CSS breakpoints -->
            <option value="break-360">Breakpoint 360px</option>
            <option value="break-480">Breakpoint 480px</option>
            <option value="break-640">Breakpoint 640px</option>
            <option value="break-768">Breakpoint 768px</option>
            <option value="break-1024">Breakpoint 1024px</option>
        </select>
        <button onclick="runTest()">üîÑ Run Test</button>
        <button onclick="copyResults()">üìã Copy Report</button>
        <button onclick="toggleGrid()" style="background: #8b5cf6;">üìê Toggle Grid</button>
        <label>
            <input type="checkbox" id="details" checked>
            Show Details
        </label>
    </div>
    
    <div class="results" id="results">
        Click "Run Test" to begin performance analysis...
    </div>
    
    <div id="frameWrapper">
        <iframe id="testFrame" src="http://localhost:8080?t=init" height="600"></iframe>
    </div>

    <script>
        const results = document.getElementById('results');
        const testFrame = document.getElementById('testFrame');
        const viewMode = document.getElementById('viewMode');
        const frameWrapper = document.getElementById('frameWrapper');
        const showDetails = document.getElementById('details');
        
        // Define all viewport dimensions
        const viewports = {
            'mobile-se': { width: 375, height: 667, label: 'iPhone SE' },
            'mobile': { width: 390, height: 844, label: 'iPhone 14' },
            'mobile-plus': { width: 428, height: 926, label: 'iPhone 14 Plus' },
            'android': { width: 412, height: 915, label: 'Android' },
            'tablet-portrait': { width: 768, height: 1024, label: 'iPad Portrait' },
            'tablet-landscape': { width: 1024, height: 768, label: 'iPad Landscape' },
            'laptop': { width: 1366, height: 768, label: 'Laptop' },
            'desktop': { width: 1920, height: 1080, label: 'Desktop FHD' },
            'desktop-wide': { width: 2560, height: 1440, label: 'Desktop Wide' },
            // Breakpoint testing
            'break-360': { width: 360, height: 640, label: '360px Breakpoint' },
            'break-480': { width: 480, height: 800, label: '480px Breakpoint' },
            'break-640': { width: 640, height: 900, label: '640px Breakpoint' },
            'break-768': { width: 768, height: 1024, label: '768px Breakpoint' },
            'break-1024': { width: 1024, height: 768, label: '1024px Breakpoint' }
        };
        
        let testData = {
            timestamp: '',
            device: '',
            metrics: {},
            shifts: [],
            verdict: ''
        };
        
        let gridOverlay = null;
        
        function updateView() {
            const mode = viewMode.value;
            const viewport = viewports[mode];
            
            // Update frame dimensions
            testFrame.style.width = viewport.width + 'px';
            testFrame.style.height = viewport.height + 'px';
            
            // Apply appropriate device frame based on type
            if (mode.includes('mobile') || mode.includes('android') || mode === 'break-360' || mode === 'break-480') {
                frameWrapper.className = 'mobile-frame';
                frameWrapper.style.width = 'fit-content';
                frameWrapper.style.margin = '0 auto';
            } else if (mode.includes('tablet') || mode === 'break-640' || mode === 'break-768') {
                frameWrapper.className = 'tablet-frame';
                frameWrapper.style.width = 'fit-content';
                frameWrapper.style.margin = '0 auto';
            } else {
                frameWrapper.className = 'desktop-frame';
                frameWrapper.style.width = 'fit-content';
                frameWrapper.style.margin = '0 auto';
                
                // Limit desktop frame size for very wide screens
                if (viewport.width > 2000) {
                    testFrame.style.transform = 'scale(0.75)';
                    testFrame.style.transformOrigin = 'center';
                } else {
                    testFrame.style.transform = 'none';
                }
            }
            
            // Update display info with device icon
            const icon = mode.includes('mobile') || mode.includes('android') ? 'üì±' :
                        mode.includes('tablet') ? 'üì±' :
                        'üíª';
            results.innerHTML = `${icon} Viewport: ${viewport.label} (${viewport.width}√ó${viewport.height})<br>
                                 CSS Breakpoints: 360px, 480px, 640px, 768px, 1024px<br>
                                 Click "Run Test" to analyze performance...`;
        }
        
        function toggleGrid() {
            if (gridOverlay) {
                gridOverlay.remove();
                gridOverlay = null;
            } else {
                // Create grid overlay
                gridOverlay = document.createElement('div');
                gridOverlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    pointer-events: none;
                    z-index: 9999;
                    background-image: 
                        linear-gradient(to right, rgba(255,0,0,0.1) 1px, transparent 1px),
                        linear-gradient(to bottom, rgba(255,0,0,0.1) 1px, transparent 1px);
                    background-size: 20px 20px;
                `;
                frameWrapper.style.position = 'relative';
                frameWrapper.appendChild(gridOverlay);
            }
        }
        
        function runTest() {
            const viewport = viewports[viewMode.value];
            results.innerHTML = '‚è≥ Testing in progress...<br><br>';
            testData = {
                timestamp: new Date().toISOString(),
                device: `${viewport.label} (${viewport.width}√ó${viewport.height})`,
                metrics: {},
                shifts: [],
                verdict: ''
            };
            
            // Force reload iframe
            testFrame.src = `http://localhost:8080?t=${Date.now()}`;
            
            // Wait for load and analyze
            testFrame.onload = () => {
                setTimeout(analyzePerformance, 100);
            };
        }
        
        function analyzePerformance() {
            try {
                // Try to access iframe performance data
                const iframeWindow = testFrame.contentWindow;
                const iframePerf = iframeWindow.performance;
                
                // Get paint metrics
                const paintEntries = iframePerf.getEntriesByType('paint');
                const fp = paintEntries.find(e => e.name === 'first-paint');
                const fcp = paintEntries.find(e => e.name === 'first-contentful-paint');
                
                // Get navigation timing
                const navTiming = iframePerf.getEntriesByType('navigation')[0];
                
                // Calculate metrics
                const fpTime = fp ? fp.startTime : 0;
                const fcpTime = fcp ? fcp.startTime : 0;
                const loadTime = navTiming ? navTiming.loadEventEnd : 0;
                
                testData.metrics = {
                    fp: fpTime,
                    fcp: fcpTime,
                    load: loadTime,
                    gap: fcpTime - fpTime
                };
                
                // Display results
                displayResults();
                
            } catch(e) {
                // Cross-origin restriction, analyze from parent window
                analyzeFallback();
            }
        }
        
        function analyzeFallback() {
            // Use parent window performance API
            const paintEntries = performance.getEntriesByType('paint');
            const fp = paintEntries.find(e => e.name === 'first-paint');
            const fcp = paintEntries.find(e => e.name === 'first-contentful-paint');
            
            testData.metrics = {
                fp: fp ? fp.startTime.toFixed(0) : 'N/A',
                fcp: fcp ? fcp.startTime.toFixed(0) : 'N/A',
                load: 'Cross-origin',
                gap: fp && fcp ? (fcp.startTime - fp.startTime).toFixed(0) : 'N/A'
            };
            
            // Monitor for layout shifts
            let cls = 0;
            const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    if (entry.entryType === 'layout-shift' && !entry.hadRecentInput) {
                        cls += entry.value;
                        
                        // Try to identify source
                        if (entry.sources && entry.sources.length > 0) {
                            entry.sources.forEach(source => {
                                if (source.node && !source.node.id?.includes('test')) {
                                    const elem = source.node;
                                    const identifier = elem.id || elem.className || elem.tagName;
                                    testData.shifts.push({
                                        value: entry.value,
                                        element: identifier
                                    });
                                }
                            });
                        }
                    }
                }
            });
            
            observer.observe({ entryTypes: ['layout-shift'] });
            
            // Collect CLS after 2 seconds
            setTimeout(() => {
                observer.disconnect();
                testData.metrics.cls = cls.toFixed(3);
                displayResults();
            }, 2000);
        }
        
        function displayResults() {
            const { metrics } = testData;
            
            // Determine verdict
            const cls = parseFloat(metrics.cls) || 0;
            const gap = parseInt(metrics.gap) || 0;
            
            let verdict = '';
            let verdictClass = '';
            
            if (cls < 0.1 && gap < 50) {
                verdict = '‚úÖ Excellent - No FOUC Detected';
                verdictClass = 'good';
            } else if (cls < 0.1) {
                verdict = '‚úÖ Good - No visible FOUC';
                verdictClass = 'good';
            } else if (cls < 0.25) {
                verdict = '‚ö†Ô∏è Warning - Minor layout shifts';
                verdictClass = 'warning';
            } else {
                verdict = '‚ùå Poor - Significant layout shifts';
                verdictClass = 'bad';
            }
            
            testData.verdict = verdict;
            
            // Build report
            let html = `<div class="${verdictClass}"><strong>Verdict:</strong> ${verdict}</div><br>`;
            
            html += `<div class="info"><strong>Device:</strong> ${testData.device}</div>`;
            html += `<div class="info"><strong>Time:</strong> ${new Date().toLocaleTimeString()}</div><br>`;
            
            html += '<strong>Core Metrics:</strong><br>';
            html += `‚Ä¢ First Paint: <span class="${metrics.fp < 1000 ? 'good' : 'warning'}">${metrics.fp}ms</span><br>`;
            html += `‚Ä¢ First Contentful Paint: <span class="${metrics.fcp < 1800 ? 'good' : 'warning'}">${metrics.fcp}ms</span><br>`;
            html += `‚Ä¢ FP‚ÜíFCP Gap: <span class="${gap < 50 ? 'good' : 'warning'}">${metrics.gap}ms</span><br>`;
            html += `‚Ä¢ CLS Score: <span class="${cls < 0.1 ? 'good' : cls < 0.25 ? 'warning' : 'bad'}">${metrics.cls}</span><br>`;
            
            if (showDetails.checked && testData.shifts.length > 0) {
                html += '<br><strong>Layout Shift Sources:</strong><br>';
                const uniqueShifts = {};
                testData.shifts.forEach(shift => {
                    if (!uniqueShifts[shift.element]) {
                        uniqueShifts[shift.element] = 0;
                    }
                    uniqueShifts[shift.element] += parseFloat(shift.value);
                });
                
                Object.entries(uniqueShifts).forEach(([elem, value]) => {
                    if (!elem.includes('test') && !elem.includes('frame')) {
                        html += `‚Ä¢ ${elem}: ${value.toFixed(3)}<br>`;
                    }
                });
            }
            
            if (cls > 0.1) {
                html += '<br><strong>Recommendations:</strong><br>';
                html += '‚Ä¢ Check sticky elements on scroll<br>';
                html += '‚Ä¢ Ensure images have width/height<br>';
                html += '‚Ä¢ Review dynamic content loading<br>';
            }
            
            results.innerHTML = html;
        }
        
        function copyResults() {
            const report = `# Performance Test Report
            
**Date:** ${new Date().toLocaleString()}
**Device:** ${testData.device}
**Verdict:** ${testData.verdict}

## Metrics
- First Paint: ${testData.metrics.fp}ms
- First Contentful Paint: ${testData.metrics.fcp}ms
- FP‚ÜíFCP Gap: ${testData.metrics.gap}ms
- CLS Score: ${testData.metrics.cls}

## Analysis
${testData.shifts.length > 0 ? 'Layout shifts detected from: ' + [...new Set(testData.shifts.map(s => s.element))].join(', ') : 'No significant layout shifts'}

---
*Clean Performance Test - Measuring site content only*`;
            
            navigator.clipboard.writeText(report).then(() => {
                showNotification('Report copied to clipboard!');
            });
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Initialize view
        updateView();
        viewMode.addEventListener('change', updateView);
    </script>
</body>
</html>