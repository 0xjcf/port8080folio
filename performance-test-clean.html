<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Performance Test - Site Only</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, system-ui, sans-serif;
            background: #1a1a1a; 
            color: #fff; 
            padding: 20px;
        }
        h1 { 
            margin-bottom: 20px; 
            color: #ff6e3c; 
            font-size: 24px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            background: #ff6e3c;
            color: #fff;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #ff5a24; }
        select {
            background: #333;
            color: #fff;
            padding: 8px;
            border: 1px solid #ff6e3c;
            border-radius: 4px;
            font-size: 14px;
        }
        .results {
            background: rgba(0,0,0,0.5);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        .good { color: #10b981; }
        .warning { color: #f59e0b; }
        .bad { color: #ef4444; }
        .info { color: #3b82f6; }
        iframe { 
            width: 100%; 
            border: 2px solid #ff6e3c;
            border-radius: 8px;
            background: white;
        }
        .mobile-frame {
            max-width: 390px;
            margin: 0 auto;
            border: 10px solid #333;
            border-radius: 20px;
            overflow: hidden;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>üéØ Clean Performance Test - Measuring Site Only</h1>
    
    <div class="controls">
        <select id="viewMode">
            <option value="mobile">Mobile (390√ó844)</option>
            <option value="tablet">Tablet (768√ó1024)</option>
            <option value="desktop">Desktop (1920√ó1080)</option>
        </select>
        <button onclick="runTest()">üîÑ Run Test</button>
        <button onclick="copyResults()">üìã Copy Report</button>
        <label>
            <input type="checkbox" id="details" checked>
            Show Details
        </label>
    </div>
    
    <div class="results" id="results">
        Click "Run Test" to begin performance analysis...
    </div>
    
    <div id="frameWrapper">
        <iframe id="testFrame" src="http://localhost:8080?t=init" height="600"></iframe>
    </div>

    <script>
        const results = document.getElementById('results');
        const testFrame = document.getElementById('testFrame');
        const viewMode = document.getElementById('viewMode');
        const frameWrapper = document.getElementById('frameWrapper');
        const showDetails = document.getElementById('details');
        
        let testData = {
            timestamp: '',
            device: '',
            metrics: {},
            shifts: [],
            verdict: ''
        };
        
        function updateView() {
            const mode = viewMode.value;
            frameWrapper.className = mode === 'mobile' ? 'mobile-frame' : '';
            
            if (mode === 'mobile') {
                testFrame.style.height = '844px';
            } else if (mode === 'tablet') {
                testFrame.style.height = '1024px';
            } else {
                testFrame.style.height = '600px';
            }
        }
        
        function runTest() {
            results.innerHTML = '‚è≥ Testing in progress...<br><br>';
            testData = {
                timestamp: new Date().toISOString(),
                device: viewMode.options[viewMode.selectedIndex].text,
                metrics: {},
                shifts: [],
                verdict: ''
            };
            
            // Force reload iframe
            testFrame.src = `http://localhost:8080?t=${Date.now()}`;
            
            // Wait for load and analyze
            testFrame.onload = () => {
                setTimeout(analyzePerformance, 100);
            };
        }
        
        function analyzePerformance() {
            try {
                // Try to access iframe performance data
                const iframeWindow = testFrame.contentWindow;
                const iframePerf = iframeWindow.performance;
                
                // Get paint metrics
                const paintEntries = iframePerf.getEntriesByType('paint');
                const fp = paintEntries.find(e => e.name === 'first-paint');
                const fcp = paintEntries.find(e => e.name === 'first-contentful-paint');
                
                // Get navigation timing
                const navTiming = iframePerf.getEntriesByType('navigation')[0];
                
                // Calculate metrics
                const fpTime = fp ? fp.startTime : 0;
                const fcpTime = fcp ? fcp.startTime : 0;
                const loadTime = navTiming ? navTiming.loadEventEnd : 0;
                
                testData.metrics = {
                    fp: fpTime,
                    fcp: fcpTime,
                    load: loadTime,
                    gap: fcpTime - fpTime
                };
                
                // Display results
                displayResults();
                
            } catch(e) {
                // Cross-origin restriction, analyze from parent window
                analyzeFallback();
            }
        }
        
        function analyzeFallback() {
            // Use parent window performance API
            const paintEntries = performance.getEntriesByType('paint');
            const fp = paintEntries.find(e => e.name === 'first-paint');
            const fcp = paintEntries.find(e => e.name === 'first-contentful-paint');
            
            testData.metrics = {
                fp: fp ? fp.startTime.toFixed(0) : 'N/A',
                fcp: fcp ? fcp.startTime.toFixed(0) : 'N/A',
                load: 'Cross-origin',
                gap: fp && fcp ? (fcp.startTime - fp.startTime).toFixed(0) : 'N/A'
            };
            
            // Monitor for layout shifts
            let cls = 0;
            const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    if (entry.entryType === 'layout-shift' && !entry.hadRecentInput) {
                        cls += entry.value;
                        
                        // Try to identify source
                        if (entry.sources && entry.sources.length > 0) {
                            entry.sources.forEach(source => {
                                if (source.node && !source.node.id?.includes('test')) {
                                    const elem = source.node;
                                    const identifier = elem.id || elem.className || elem.tagName;
                                    testData.shifts.push({
                                        value: entry.value,
                                        element: identifier
                                    });
                                }
                            });
                        }
                    }
                }
            });
            
            observer.observe({ entryTypes: ['layout-shift'] });
            
            // Collect CLS after 2 seconds
            setTimeout(() => {
                observer.disconnect();
                testData.metrics.cls = cls.toFixed(3);
                displayResults();
            }, 2000);
        }
        
        function displayResults() {
            const { metrics } = testData;
            
            // Determine verdict
            const cls = parseFloat(metrics.cls) || 0;
            const gap = parseInt(metrics.gap) || 0;
            
            let verdict = '';
            let verdictClass = '';
            
            if (cls < 0.1 && gap < 50) {
                verdict = '‚úÖ Excellent - No FOUC Detected';
                verdictClass = 'good';
            } else if (cls < 0.1) {
                verdict = '‚úÖ Good - No visible FOUC';
                verdictClass = 'good';
            } else if (cls < 0.25) {
                verdict = '‚ö†Ô∏è Warning - Minor layout shifts';
                verdictClass = 'warning';
            } else {
                verdict = '‚ùå Poor - Significant layout shifts';
                verdictClass = 'bad';
            }
            
            testData.verdict = verdict;
            
            // Build report
            let html = `<div class="${verdictClass}"><strong>Verdict:</strong> ${verdict}</div><br>`;
            
            html += `<div class="info"><strong>Device:</strong> ${testData.device}</div>`;
            html += `<div class="info"><strong>Time:</strong> ${new Date().toLocaleTimeString()}</div><br>`;
            
            html += '<strong>Core Metrics:</strong><br>';
            html += `‚Ä¢ First Paint: <span class="${metrics.fp < 1000 ? 'good' : 'warning'}">${metrics.fp}ms</span><br>`;
            html += `‚Ä¢ First Contentful Paint: <span class="${metrics.fcp < 1800 ? 'good' : 'warning'}">${metrics.fcp}ms</span><br>`;
            html += `‚Ä¢ FP‚ÜíFCP Gap: <span class="${gap < 50 ? 'good' : 'warning'}">${metrics.gap}ms</span><br>`;
            html += `‚Ä¢ CLS Score: <span class="${cls < 0.1 ? 'good' : cls < 0.25 ? 'warning' : 'bad'}">${metrics.cls}</span><br>`;
            
            if (showDetails.checked && testData.shifts.length > 0) {
                html += '<br><strong>Layout Shift Sources:</strong><br>';
                const uniqueShifts = {};
                testData.shifts.forEach(shift => {
                    if (!uniqueShifts[shift.element]) {
                        uniqueShifts[shift.element] = 0;
                    }
                    uniqueShifts[shift.element] += parseFloat(shift.value);
                });
                
                Object.entries(uniqueShifts).forEach(([elem, value]) => {
                    if (!elem.includes('test') && !elem.includes('frame')) {
                        html += `‚Ä¢ ${elem}: ${value.toFixed(3)}<br>`;
                    }
                });
            }
            
            if (cls > 0.1) {
                html += '<br><strong>Recommendations:</strong><br>';
                html += '‚Ä¢ Check sticky elements on scroll<br>';
                html += '‚Ä¢ Ensure images have width/height<br>';
                html += '‚Ä¢ Review dynamic content loading<br>';
            }
            
            results.innerHTML = html;
        }
        
        function copyResults() {
            const report = `# Performance Test Report
            
**Date:** ${new Date().toLocaleString()}
**Device:** ${testData.device}
**Verdict:** ${testData.verdict}

## Metrics
- First Paint: ${testData.metrics.fp}ms
- First Contentful Paint: ${testData.metrics.fcp}ms
- FP‚ÜíFCP Gap: ${testData.metrics.gap}ms
- CLS Score: ${testData.metrics.cls}

## Analysis
${testData.shifts.length > 0 ? 'Layout shifts detected from: ' + [...new Set(testData.shifts.map(s => s.element))].join(', ') : 'No significant layout shifts'}

---
*Clean Performance Test - Measuring site content only*`;
            
            navigator.clipboard.writeText(report).then(() => {
                showNotification('Report copied to clipboard!');
            });
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Initialize view
        updateView();
        viewMode.addEventListener('change', updateView);
    </script>
</body>
</html>